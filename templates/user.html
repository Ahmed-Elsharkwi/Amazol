<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/8446a08b11.js" crossorigin="anonymous"></script>


    <title>User Profile</title>
    <link rel="stylesheet" href="styles.css">
    <style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f0f0f0;
}
.logo {
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    left: 40px;

}
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #ffffff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.profile-info h1 {
    margin: 0 0 20px 0;
    color: #2c3e50;
}

.editable-container_1 {
    margin-bottom: 15px;
}

.display-section, .edit-section {
    display: flex;
    align-items: center;
}

.edit-section {
    display: none;
}

label {
    font-size: 18px;
    margin-right: 10px;
    min-width: 70px;
}

.editable-text, .editable-field {
    width: 250px;
    padding: 5px 10px;
    border: 1px solid #bdc3c7;
    border-radius: 5px;
    font-size: 16px;
}

.edit-button, .save-button {
    margin-left: 10px;
    cursor: pointer;
    font-size: 20px;
    background: none;
    border: none;
    color: #3498db;
}

.profile-picture {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    overflow: hidden;
    border: 5px solid #3498db;
}

.profile-picture img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

@media (max-width: 768px) {
    main {
        grid-template-columns: 1fr;
    }

    .profile-header {
        flex-direction: column;
        align-items: center;
    }

    .profile-picture {
        margin-top: 20px;
    }

    .editable-text, .editable-field {
        width: 200px;
    }
}

.credit-card-form {
    grid-column: 2 / 3;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
}

.credit-card-form form {
    display: flex;
    flex-direction: column;
}

.credit-card-form input,
.credit-card-form select {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.credit-card-form .expiry-date {
    display: flex;
    align-items: center;
    gap: 10px;
}

.credit-card-form .expiry-date select {
    flex: 1;
}

.credit-card-form button {
    padding: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.card-list {
    grid-column: 2 / 3;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
}

.card-list ul {
    list-style-type: none;
    padding: 0;
}

.card-list li {
    background-color: #f9f9f9;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-list button {
    padding: 5px 10px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    margin-left: 10px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 10px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

#modify-card-form {
    display: flex;
    flex-direction: column;
}

#modify-card-form input,
#modify-card-form select {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

#modify-card-form button {
    padding: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
@media (max-width: 768px) {
    main {
        grid-template-columns: 1fr;
    }

    .profile-header {
        flex-direction: column;
        align-items: center;
    }

    .profile-picture {
        margin-top: 20px;
    }

    .editable-text, .editable-field {
        width: 200px;
    }
}
    </style>
</head>
<body>
    <h1 class="logo" onclick="get_main_page()">Amazol</h1>
    <div class="container">
        <header class="profile-header">
            <div class="profile-info">
                <h1 id="seller-name">John Doe</h1>
                <div id="email-container" class="editable-container_1">
                    <div id="email-display" class="display-section">
                        <label for="email">Email:</label>
                        <div id="email-text" class="editable-text">john@example.com</div>
                    </div>
                </div>
                <div id="address-container" class="editable-container">
                    <div id="address-display" class="display-section">
                        <label for="address">Address:</label>
                        <div id="address-text" class="editable-text">123 Main St, City, Country</div>
                        <i class="fa-sharp fa-solid fa-pen-to-square edit-button"></i>
                    </div>
                    <div id="address-edit" class="edit-section">
                        <label for="address">Address:</label>
                        <div id="address-editable" class="editable-field" contenteditable="true">123 Main St, City, Country</div>
                        <button class="save-button">✔️</button>
                    </div>
                </div>
                <div id="phone-container" class="editable-container">
                    <div id="phone-display" class="display-section">
                        <label for="phone">Phone:</label>
                        <div id="phone-text" class="editable-text">+1 234 567 8900</div>
                        <i class="fa-sharp fa-solid fa-pen-to-square edit-button"></i>
                    </div>
                    <div id="phone-edit" class="edit-section">
                        <label for="phone">Phone:</label>
                        <div id="phone-editable" class="editable-field" contenteditable="true">+1 234 567 8900</div>
                        <button class="save-button">✔️</button>
                    </div>
                </div>
            </div>
            <div class="profile-picture">
                <img id="profile-image" src="/placeholder.svg" alt="Seller Profile Picture">
            </div>
        </header>
        <div class="credit-card-form">
            <h2>Add Credit Card</h2>
            <form id="credit-card-form">
                <input type="text" id="card-number" placeholder="Card Number" required maxlength="19">
                <input type="text" id="card-holder" placeholder="Card Holder Name" required>
                <input type="text" id="card-cvv" placeholder="CVV" required maxlength="4">
                <div class="expiry-date">
                    <label for="card-expiry-month">Expiration Date:</label>
                    <select id="card-expiry-month" required>
                        <option value="">Month</option>
                    </select>
                    <select id="card-expiry-year" required>
                        <option value="">Year</option>
                    </select>
                </div>
                <button type="submit">Add Card</button>
            </form>
        </div>
        <div class="card-list">
            <h2>Saved Cards</h2>
            <ul id="saved-cards"></ul>
        </div>
    </div>

    <div id="modify-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Modify Card</h2>
            <form id="modify-card-form">
                <input type="text" id="modify-card-holder" placeholder="Card Holder Name" required>
                <div class="expiry-date">
                    <label for="modify-card-expiry-month">Expiration Date:</label>
                    <select id="modify-card-expiry-month" required>
                        <option value="">Month</option>
                    </select>
                    <select id="modify-card-expiry-year" required>
                        <option value="">Year</option>
                    </select>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
    async function get_main_page() {
        window.location.href = "http://localhost:3000/";

    }
    async function get_user_info() {
        try{
                const response_1 = await fetch('http://localhost:5000/Amazol/user_info', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response_1.json()
                if (response_1.ok){

                    const user_image = document.getElementById('profile-image')
                    const user_name = document.getElementById('seller-name')
                    const user_email_address = document.getElementById('email-text')
                    const user_address = document.getElementById('address-text')
                    const user_phone_number = document.getElementById('phone-text')

                    user_image.src = data.photo_url
                    user_name.innerHTML = data.name
                    user_email_address.innerHTML = data.email
                    user_address.innerHTML = data.address
                    user_phone_number.innerHTML = data.phone_number


                }
                else{
                    if (response_1.status == 401){
                        window.location.href = 'http://localhost:3000/login?type=user&next_page=/user_profile'
                        return null
                    }
                    else{
                        console.log(data['state'])
                    }
                }

            }
            catch (error){
                alert(error)
            }
        }
async function setupEditableFields() {
    const editableContainers = document.querySelectorAll('.editable-container');
    editableContainers.forEach(container => {
        const displaySection = container.querySelector('.display-section');
        const editSection = container.querySelector('.edit-section');
        const editButton = container.querySelector('.edit-button');
        const saveButton = container.querySelector('.save-button');
        const textElement = container.querySelector('.editable-text');
        const editableElement = container.querySelector('.editable-field');
        editSection.style.display = 'none';

        editButton.addEventListener('click', () => {
            displaySection.style.display = 'none';
            editableElement.innerHTML = textElement.innerHTML
            editSection.style.display = 'flex';
            editableElement.focus();
        });

        saveButton.addEventListener('click', async() => {
            const value = editableElement.innerText;
            const id = editableElement.id
            let key = ""
            textElement.innerText = value;
            displaySection.style.display = 'flex';
            editSection.style.display = 'none';

            if (id == "phone-editable"){
                key = "phone_number" 
            }
            else{
                key = "address"
            }
    
            let data = {[key]: value}
            const response = await fetch(`http://localhost:5000/Amazol/new_user_info`, {
                method: 'PUT',
                credentials:"include",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            const message = await response.json()
            alert(message['state'])
        });
    });
}
      document.addEventListener('DOMContentLoaded', async () => {
        let cards = [];
        let currentCardIndex = -1;
        await get_user_info()
        await setupEditableFields()
        const creditCardForm = document.getElementById('credit-card-form');
        const savedCardsList = document.getElementById('saved-cards');
        const cardExpiryMonth = document.getElementById('card-expiry-month');
        const cardExpiryYear = document.getElementById('card-expiry-year');
        const modifyModal = document.getElementById('modify-modal');
        const modifyCardForm = document.getElementById('modify-card-form');
        const modifyCardExpiryMonth = document.getElementById('modify-card-expiry-month');
        const modifyCardExpiryYear = document.getElementById('modify-card-expiry-year');
        const closeModal = document.getElementsByClassName('close')[0];
        

        try{
                const response = await fetch('http://localhost:5000/Amazol/payment_info', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json()
                if (response.ok){
                    for (payment_method in data){
                        cards.push(data[payment_method])
                    }
                    updateCardList()
                }

                else{
                    if (response.status != 401){
                        alert(data['state'])
                    }
                }
            
            }
            catch(error){
                alert(error)
        }
    // Populate month selects
    [cardExpiryMonth, modifyCardExpiryMonth].forEach(select => {
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i.toString().padStart(2, '0');
            option.textContent = i.toString().padStart(2, '0');
            select.appendChild(option);
        }
    });

    // Populate year selects
    const currentYear = new Date().getFullYear();
    [cardExpiryYear, modifyCardExpiryYear].forEach(select => {
        for (let i = currentYear; i <= currentYear + 10; i++) {
            const option = document.createElement('option');
            option.value = i.toString();
            option.textContent = i.toString();
            select.appendChild(option);
        }
    });

    // Input validation
    document.getElementById('card-number').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '').slice(0, 19);
    });

    document.getElementById('card-holder').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
    });

    document.getElementById('card-cvv').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '').slice(0, 4);
    });

    creditCardForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const number = document.getElementById('card-number').value;
        const holder_name = document.getElementById('card-holder').value;
        const cardExpiryMonth = document.getElementById('card-expiry-month').value;
        const cardExpiryYear = document.getElementById('card-expiry-year').value;
        const cardCvv = document.getElementById('card-cvv').value;

        if (number.length < 14) {
            alert('Card number must be at least 14 digits long');
            return;
        }
        const card_info = {
            'number': number, 
            'holder_name': holder_name, 
            'cvv': cardCvv, 
            'month': cardExpiryMonth, 
            'year': cardExpiryYear
        }
        try {
            const response = await fetch('http://localhost:5000/Amazol/new_payment_method',{
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(card_info),

            })
            message = await response.json()
            if (response.ok){
                const newCard = { 
                    number, 
                    holder_name, 
                    expiry_date: `${cardExpiryMonth}/${cardExpiryYear}`,
                    "id": message['id'],
                };
                cards.push(newCard);
                updateCardList();
                creditCardForm.reset();
            }
            else{
                alert(message['state'])
            }

        }
        catch (error){
            alert(error)
        }
    });

    function updateCardList() {
        savedCardsList.innerHTML = '';
        cards.forEach((card, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>
                    ${card.number.slice(-4).padStart(16, '*')} | 
                    ${card.holder_name} | 
                    Expires: ${card.expiry_date}
                </span>
                <div>
                    <button class="modify-btn" data-index="${index}">Modify</button>
                    <button class="delete-btn" data-index="${index}">Delete</button>
                </div>
            `;
            savedCardsList.appendChild(li);
        });

        // Add event listeners for modify and delete buttons
        document.querySelectorAll('.modify-btn').forEach(btn => {
            btn.addEventListener('click', openModifyModal);
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', deleteCard);
        });
    }

    function openModifyModal(e) {
        currentCardIndex = e.target.getAttribute('data-index');
        const card = cards[currentCardIndex];
        document.getElementById('modify-card-holder').value = card.holder_name;
        const [month, year] = card.expiry_date.split('/');
        document.getElementById('modify-card-expiry-month').value = month;
        document.getElementById('modify-card-expiry-year').value = `${year}`;
        modifyModal.style.display = 'block';
    }

    closeModal.onclick = function() {
        modifyModal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modifyModal) {
            modifyModal.style.display = 'none';
        }
    }

    modifyCardForm.addEventListener('submit', async(e) => {
        e.preventDefault();
        const holder_name = document.getElementById('modify-card-holder').value;
        const cardExpiryMonth = document.getElementById('modify-card-expiry-month').value;
        const cardExpiryYear = document.getElementById('modify-card-expiry-year').value;
        cards[currentCardIndex] = {
            'holder_name': holder_name,
            'month': cardExpiryMonth,
            'year': cardExpiryYear,
            'expiry_date': `${cardExpiryMonth}/${cardExpiryYear}`,
            'id': cards[currentCardIndex].id,
            'number': cards[currentCardIndex].number
        };

        try {
            const response = await fetch('http://localhost:5000/Amazol/new_payment_info', {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cards[currentCardIndex]),

            })
            const message = await response.json()
            if (response.ok){
                updateCardList();
                modifyModal.style.display = 'none';
            }
            alert(message["state"])
        } catch (error) {
            alert(error)
        }
    });

    async function deleteCard(e) {
        const index = e.target.getAttribute('data-index');
        try {
            const response = await fetch('http://localhost:5000/Amazol/payment_not_exist', {
                method: 'DELETE',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'id':cards[index].id}),

            })
            const message = await response.json()
            if (response.ok){
                cards.splice(index, 1);
                updateCardList();
            }
            alert(message["state"])
        } catch (error) {
            alert(error)
        }
    }


    document.getElementById('modify-card-holder').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
    });
});
    </script>
</body>
</html>